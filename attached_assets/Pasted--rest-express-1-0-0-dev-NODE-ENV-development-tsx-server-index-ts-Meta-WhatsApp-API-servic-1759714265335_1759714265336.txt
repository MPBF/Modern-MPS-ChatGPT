
> rest-express@1.0.0 dev
> NODE_ENV=development tsx server/index.ts

✅ Meta WhatsApp API service initialized successfully
✅ Twilio WhatsApp service initialized successfully
🚀 Using Meta WhatsApp Business API directly
✅ Using PostgreSQL session store for development - sessions will persist across server restarts
🔒 Performing startup password security check...
✅ Password security check passed: All 50 user passwords are properly hashed
[SystemHealthMonitor] نظام مراقبة السلامة مُفعل
[SystemHealthMonitor] تم تحميل قواعد التحذيرات
[AlertManager] نظام إدارة التحذيرات مُفعل
[DataValidator] نظام التحقق من صحة البيانات مُفعل
[DataValidator] تم تحميل 9 قاعدة تحقق افتراضية
[SmartAlerts] نظام التحذيرات الذكية مُفعل ✅
[AlertManager] تم تحميل 0 قاعدة تحذير نشطة
[DataValidator] تم تسجيل المدققات المخصصة
[DataValidator] تم تشغيل نظام التحقق من البيانات بنجاح ✅
[AlertManager] تم تحميل 0 تحذير نشط
[AlertManager] تم تشغيل نظام إدارة التحذيرات بنجاح ✅
[SystemHealthMonitor] تم تحميل 0 من أوقات التحذير من قاعدة البيانات
[SystemHealthMonitor] تم إنشاء فحوصات السلامة الافتراضية
[SystemHealthMonitor] بدأت المراقبة الدورية
[SystemHealthMonitor] تم تشغيل نظام المراقبة بنجاح ✅
1:10:11 AM [express] serving on port 5000
1:12:02 AM [express] GET /api/me 304 in 324ms :: {"user":"[Object]","success":true}
🔄 Session extended for user 1 on /api/notifications
🔄 Session extended for user 1 on /api/dashboard/stats
🔄 Session extended for user 1 on /api/production/hierarchical-orders
🔄 Session extended for user 1 on /api/sections
🔄 Session extended for user 1 on /api/production/film-queue
1:12:02 AM [express] GET /api/notifications 200 in 154ms :: {"data":"[Array:2]"}
1:12:03 AM [express] GET /api/production/film-queue 304 in 169ms :: {"data":"[Array:1]"}
1:12:03 AM [express] GET /api/sections 304 in 331ms :: {"data":"[Array:7]"}
1:12:03 AM [express] GET /api/dashboard/stats 304 in 344ms :: {"activeOrders":0,"productionRate":0,"…
🔄 Session extended for user 1 on /api/production/cutting-queue
🔄 Session extended for user 1 on /api/production/printing-queue
🔄 Session extended for user 1 on /api/production/grouped-cutting-queue
1:12:03 AM [express] GET /api/production/cutting-queue 304 in 122ms :: {"data":"[Array:0]"}
1:12:03 AM [express] GET /api/production/hierarchical-orders 304 in 477ms :: {"data":"[Array:1]"}
1:12:03 AM [express] GET /api/production/printing-queue 304 in 124ms :: {"data":"[Array:0]"}
1:12:03 AM [express] GET /api/production/grouped-cutting-queue 304 in 121ms :: {"data":"[Array:0]"}
🔄 Session extended for user 1 on /api/rolls
🔄 Session extended for user 1 on /api/machines
1:12:03 AM [express] GET /api/rolls 304 in 119ms :: {"data":"[Array:0]"}
1:12:03 AM [express] GET /api/machines 304 in 127ms :: {"data":"[Array:25]"}
🔄 Session extended for user 1 on /api/production-orders
🔄 Session extended for user 1 on /api/notifications/stream
[System] Applying database optimizations...
[DB Optimization] Creating performance indexes...
[DB Optimization] Creating text search indexes...
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713123716_82fgcz16w
[SSE] New connection established for user 1, connectionId: 1_1759713123716_82fgcz16w
1:12:03 AM [express] GET /api/production-orders 304 in 123ms :: {"data":"[Array:1]"}
[DB Optimization] Text search indexes created successfully
[DB Optimization] Performance indexes created successfully
[Cache] Cleaned up 2 stale entries. Active: 0
🔄 Session extended for user 1 on /api/production/hierarchical-orders
1:13:34 AM [express] GET /api/production/hierarchical-orders 304 in 425ms :: {"data":"[Array:1]"}
[Cache] Cleaned up 1 stale entries. Active: 0
🔄 Session extended for user 1 on /api/notifications
🔄 Session extended for user 1 on /api/attendance
🔄 Session extended for user 1 on /api/users/1
🔄 Session extended for user 1 on /api/violations
🔄 Session extended for user 1 on /api/user-requests
Fetching user requests - Session ID: _-0dYec1wrkXKeuIGvuiV7cWBndlVfAT
Fetching user requests - User ID in session: 1
Found 0 user requests
1:14:20 AM [express] GET /api/notifications 304 in 312ms :: {"data":"[Array:2]"}
1:14:20 AM [express] GET /api/attendance 304 in 323ms :: {"data":"[Array:20]"}
1:14:20 AM [express] GET /api/users/1 304 in 312ms :: {"id":1,"username":"AbuKhalid","display_name":…
1:14:20 AM [express] GET /api/violations 304 in 314ms :: {"data":"[Array:0]"}
1:14:20 AM [express] GET /api/user-requests 304 in 316ms :: {"data":"[Array:0]"}
🔄 Session extended for user 1 on /api/attendance/daily-status/1
1:14:20 AM [express] GET /api/attendance/daily-status/1 304 in 122ms :: {"hasCheckedIn":false,"hasSt…
🔄 Session extended for user 1 on /api/attendance
Creating attendance with data: { user_id: 1, status: 'حاضر', date: '2025-10-06' }
Executing query: 
        INSERT INTO attendance (user_id, status, check_in_time, check_out_time, lunch_start_time, lunch_end_time, notes, date)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
        RETURNING *
       with values: [
  1,
  'حاضر',
  '2025-10-06T01:14:23.218Z',
  null,
  null,
  null,
  '',
  '2025-10-06'
]
Created attendance: {
  id: 75,
  user_id: 1,
  status: 'حاضر',
  check_in_time: 2025-10-06T01:14:23.218Z,
  check_out_time: null,
  lunch_start_time: null,
  lunch_end_time: null,
  notes: '',
  created_by: null,
  updated_by: null,
  date: 2025-10-06T00:00:00.000Z,
  created_at: 2025-10-06T01:14:23.252Z,
  updated_at: 2025-10-06T01:14:23.252Z
}
1:14:23 AM [express] POST /api/attendance 201 in 257ms :: {"id":75,"user_id":"[REDACTED]","status":"…
🔄 Session extended for user 1 on /api/attendance/daily-status/1
🔄 Session extended for user 1 on /api/attendance
1:14:24 AM [express] GET /api/attendance/daily-status/1 200 in 125ms :: {"hasCheckedIn":true,"hasSta…
1:14:24 AM [express] GET /api/attendance 200 in 126ms :: {"data":"[Array:21]"}
🔄 Session extended for user 1 on /api/users
🔄 Session extended for user 1 on /api/customers
🔄 Session extended for user 1 on /api/orders
🔄 Session extended for user 1 on /api/production-orders
🔄 Session extended for user 1 on /api/items
🔄 Session extended for user 1 on /api/customer-products
1:14:28 AM [express] GET /api/users 304 in 126ms :: {"data":"[Array:50]"}
1:14:28 AM [express] GET /api/orders 304 in 128ms :: {"data":"[Array:1]","count":1,"success":true}
1:14:28 AM [express] GET /api/production-orders 304 in 136ms :: {"data":"[Array:1]"}
1:14:28 AM [express] GET /api/items 304 in 136ms :: {"data":"[Array:72]"}
1:14:28 AM [express] GET /api/customers 304 in 381ms :: {"data":"[Array:2172]"}
1:14:29 AM [express] GET /api/customer-products 304 in 859ms :: {"data":"[Array:4817]"}
🔄 Session extended for user 1 on /api/rolls
🔄 Session extended for user 1 on /api/machines
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713274840_48u7wgv6k
[SSE] New connection established for user 1, connectionId: 1_1759713274840_48u7wgv6k
1:14:34 AM [express] GET /api/rolls 304 in 123ms :: {"data":"[Array:0]"}
1:14:34 AM [express] GET /api/machines 304 in 122ms :: {"data":"[Array:25]"}
🔄 Session extended for user 1 on /api/customers
🔄 Session extended for user 1 on /api/sections
🔄 Session extended for user 1 on /api/categories
🔄 Session extended for user 1 on /api/customer-products
🔄 Session extended for user 1 on /api/items
1:14:38 AM [express] GET /api/categories 304 in 119ms :: {"data":"[Array:10]"}
1:14:38 AM [express] GET /api/sections 304 in 131ms :: {"data":"[Array:7]"}
1:14:38 AM [express] GET /api/items 304 in 121ms :: {"data":"[Array:72]"}
1:14:38 AM [express] GET /api/customers 304 in 363ms :: {"data":"[Array:2172]"}
🔄 Session extended for user 1 on /api/machines
🔄 Session extended for user 1 on /api/users
🔄 Session extended for user 1 on /api/locations
1:14:38 AM [express] GET /api/customer-products 304 in 603ms :: {"data":"[Array:4817]"}
1:14:38 AM [express] GET /api/users 304 in 222ms :: {"data":"[Array:50]"}
1:14:38 AM [express] GET /api/machines 304 in 227ms :: {"data":"[Array:25]"}
🔄 Session extended for user 1 on /api/roles
1:14:38 AM [express] GET /api/locations 304 in 241ms :: {"data":"[Array:2]"}
1:14:39 AM [express] GET /api/roles 304 in 121ms :: {"data":"[Array:7]"}
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713298283_48835m7fd
[SSE] New connection established for user 1, connectionId: 1_1759713298283_48835m7fd
🔄 Session extended for user 1 on /api/notifications/user
🔄 Session extended for user 1 on /api/notifications
1:14:58 AM [express] GET /api/notifications 200 in 314ms :: {"data":"[Array:20]"}
1:14:58 AM [express] GET /api/notifications/user 200 in 495ms :: {"success":true,"notifications":"[A…
🔄 Session extended for user 1 on /api/notifications/delete/11673
1:15:09 AM [express] DELETE /api/notifications/delete/11673 200 in 312ms :: {"success":true,"message…
🔄 Session extended for user 1 on /api/notifications/user
1:15:10 AM [express] GET /api/notifications/user 200 in 300ms :: {"success":true,"notifications":"[A…
🔄 Session extended for user 1 on /api/notifications
1:15:10 AM [express] GET /api/notifications 200 in 121ms :: {"data":"[Array:19]"}
🔄 Session extended for user 1 on /api/notifications/delete/11671
1:15:11 AM [express] DELETE /api/notifications/delete/11671 200 in 118ms :: {"success":true,"message…
🔄 Session extended for user 1 on /api/notifications
🔄 Session extended for user 1 on /api/notifications/user
1:15:12 AM [express] GET /api/notifications 200 in 475ms :: {"data":"[Array:18]"}
1:15:12 AM [express] GET /api/notifications/user 200 in 480ms :: {"success":true,"notifications":"[A…
🔄 Session extended for user 1 on /api/customers
🔄 Session extended for user 1 on /api/items
🔄 Session extended for user 1 on /api/sections
1:15:17 AM [express] GET /api/items 304 in 122ms :: {"data":"[Array:72]"}
1:15:17 AM [express] GET /api/sections 304 in 331ms :: {"data":"[Array:7]"}
1:15:17 AM [express] GET /api/customers 304 in 357ms :: {"data":"[Array:2172]"}
🔄 Session extended for user 1 on /api/customer-products
🔄 Session extended for user 1 on /api/categories
🔄 Session extended for user 1 on /api/machines
1:15:17 AM [express] GET /api/categories 304 in 124ms :: {"data":"[Array:10]"}
1:15:17 AM [express] GET /api/machines 304 in 117ms :: {"data":"[Array:25]"}
1:15:17 AM [express] GET /api/customer-products 304 in 354ms :: {"data":"[Array:4817]"}
🔄 Session extended for user 1 on /api/users
🔄 Session extended for user 1 on /api/locations
🔄 Session extended for user 1 on /api/roles
1:15:18 AM [express] GET /api/users 304 in 121ms :: {"data":"[Array:50]"}
1:15:18 AM [express] GET /api/locations 304 in 120ms :: {"data":"[Array:2]"}
1:15:18 AM [express] GET /api/roles 304 in 116ms :: {"data":"[Array:7]"}
🔄 Session extended for user 1 on /api/production/real-time-stats
🔄 Session extended for user 1 on /api/production/alerts
🔄 Session extended for user 1 on /api/production/role-performance
🔄 Session extended for user 1 on /api/production/efficiency-metrics
🔄 Session extended for user 1 on /api/production/machine-utilization
🔄 Session extended for user 1 on /api/production/user-performance
1:15:49 AM [express] GET /api/production/real-time-stats 200 in 336ms :: {"currentStats":"[Object]",…
Database error during getUserPerformanceStats: error: column "rolls_created" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:2877:16)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getUserPerformanceStats (/home/runner/workspace/server/storage.ts:2833:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5763:27) {
  length: 115,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '1472',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching user performance stats: DatabaseError: خطأ في قاعدة البيانات أثناء getUserPerformanceStats - لجميع المستخدمين
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getUserPerformanceStats (/home/runner/workspace/server/storage.ts:2833:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5763:27) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
Database error during getMachineUtilizationStats: error: column "total_weight" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:3170:30)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getMachineUtilizationStats (/home/runner/workspace/server/storage.ts:3163:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5934:34) {
  length: 113,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '884',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching machine utilization stats: DatabaseError: خطأ في قاعدة البيانات أثناء getMachineUtilizationStats - إحصائيات استخدام المكائن
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getMachineUtilizationStats (/home/runner/workspace/server/storage.ts:3163:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5934:34) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
Database error during getRolePerformanceStats: error: column "total_weight_kg" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:2895:27)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getRolePerformanceStats (/home/runner/workspace/server/storage.ts:2888:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5805:27) {
  length: 116,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '783',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching role performance stats: DatabaseError: خطأ في قاعدة البيانات أثناء getRolePerformanceStats - أداء الأدوار
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getRolePerformanceStats (/home/runner/workspace/server/storage.ts:2888:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5805:27) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
1:15:49 AM [express] GET /api/production/user-performance 500 in 354ms :: {"message":"خطأ في جلب إحص…
1:15:49 AM [express] GET /api/production/efficiency-metrics 200 in 366ms :: {"efficiency":"[Object]"…
1:15:49 AM [express] GET /api/production/role-performance 500 in 376ms :: {"message":"خطأ في جلب إحص…
1:15:49 AM [express] GET /api/production/machine-utilization 500 in 368ms :: {"message":"خطأ في جلب …
1:15:49 AM [express] GET /api/production/alerts 200 in 445ms :: {"alerts":"[Array:0]","alertCount":0…
🔄 Session extended for user 1 on /api/production/user-performance
🔄 Session extended for user 1 on /api/production/role-performance
🔄 Session extended for user 1 on /api/production/machine-utilization
Database error during getUserPerformanceStats: error: column "rolls_created" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:2877:16)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getUserPerformanceStats (/home/runner/workspace/server/storage.ts:2833:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5763:27) {
  length: 115,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '1472',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching user performance stats: DatabaseError: خطأ في قاعدة البيانات أثناء getUserPerformanceStats - لجميع المستخدمين
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getUserPerformanceStats (/home/runner/workspace/server/storage.ts:2833:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5763:27) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
Database error during getRolePerformanceStats: error: column "total_weight_kg" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:2895:27)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getRolePerformanceStats (/home/runner/workspace/server/storage.ts:2888:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5805:27) {
  length: 116,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '783',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching role performance stats: DatabaseError: خطأ في قاعدة البيانات أثناء getRolePerformanceStats - أداء الأدوار
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getRolePerformanceStats (/home/runner/workspace/server/storage.ts:2888:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5805:27) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
Database error during getMachineUtilizationStats: error: column "total_weight" does not exist
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/storage.ts:3170:30)
    at async withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:381:12)
    at async DatabaseStorage.getMachineUtilizationStats (/home/runner/workspace/server/storage.ts:3163:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5934:34) {
  length: 113,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '884',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
Error fetching machine utilization stats: DatabaseError: خطأ في قاعدة البيانات أثناء getMachineUtilizationStats - إحصائيات استخدام المكائن
    at handleDatabaseError (/home/runner/workspace/server/storage.ts:369:9)
    at withDatabaseErrorHandling (/home/runner/workspace/server/storage.ts:383:5)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async DatabaseStorage.getMachineUtilizationStats (/home/runner/workspace/server/storage.ts:3163:12)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:5934:34) {
  code: '42703',
  constraint: undefined,
  table: undefined
}
1:15:51 AM [express] GET /api/production/user-performance 500 in 125ms :: {"message":"خطأ في جلب إحص…
1:15:51 AM [express] GET /api/production/role-performance 500 in 145ms :: {"message":"خطأ في جلب إحص…
1:15:51 AM [express] GET /api/production/machine-utilization 500 in 147ms :: {"message":"خطأ في جلب …
🔄 Session extended for user 1 on /api/production/hierarchical-orders
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713364413_wu4bbjkzd
[SSE] New connection established for user 1, connectionId: 1_1759713364413_wu4bbjkzd
🔄 Session extended for user 1 on /api/rolls
1:16:04 AM [express] GET /api/rolls 304 in 303ms :: {"data":"[Array:0]"}
1:16:04 AM [express] GET /api/production/hierarchical-orders 304 in 425ms :: {"data":"[Array:1]"}
[Cache] Cleaned up 1 stale entries. Active: 0
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713405916_mw0aqqwg9
[SSE] New connection established for user 1, connectionId: 1_1759713405916_mw0aqqwg9
🔄 Session extended for user 1 on /api/notifications
🔄 Session extended for user 1 on /api/notifications/user
1:16:46 AM [express] GET /api/notifications 200 in 314ms :: {"data":"[Array:0]"}
1:16:46 AM [express] GET /api/notifications/user 304 in 481ms :: {"success":true,"notifications":"[A…
🔄 Session extended for user 1 on /api/production-orders
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713409584_g97nv77wj
[SSE] New connection established for user 1, connectionId: 1_1759713409584_g97nv77wj
1:16:49 AM [express] GET /api/production-orders 304 in 122ms :: {"data":"[Array:1]"}
🔄 Session extended for user 1 on /api/orders
1:16:50 AM [express] GET /api/orders 304 in 119ms :: {"data":"[Array:1]","count":1,"success":true}
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:57 AM [express] POST /api/production-orders/preview-quantities 200 in 678ms :: {"success":true,…
1:17:57 AM [express] POST /api/production-orders/preview-quantities 200 in 717ms :: {"success":true,…
1:17:57 AM [express] POST /api/production-orders/preview-quantities 200 in 744ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:58 AM [express] POST /api/production-orders/preview-quantities 200 in 220ms :: {"success":true,…
1:17:58 AM [express] POST /api/production-orders/preview-quantities 200 in 318ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:58 AM [express] POST /api/production-orders/preview-quantities 200 in 244ms :: {"success":true,…
1:17:58 AM [express] POST /api/production-orders/preview-quantities 200 in 358ms :: {"success":true,…
1:17:58 AM [express] POST /api/production-orders/preview-quantities 200 in 168ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:59 AM [express] POST /api/production-orders/preview-quantities 200 in 191ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:59 AM [express] POST /api/production-orders/preview-quantities 200 in 168ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:17:59 AM [express] POST /api/production-orders/preview-quantities 200 in 190ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:00 AM [express] POST /api/production-orders/preview-quantities 200 in 200ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:00 AM [express] POST /api/production-orders/preview-quantities 200 in 176ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:01 AM [express] POST /api/production-orders/preview-quantities 200 in 179ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:01 AM [express] POST /api/production-orders/preview-quantities 200 in 172ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:02 AM [express] POST /api/production-orders/preview-quantities 200 in 234ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:02 AM [express] POST /api/production-orders/preview-quantities 200 in 243ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:03 AM [express] POST /api/production-orders/preview-quantities 200 in 195ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:03 AM [express] POST /api/production-orders/preview-quantities 200 in 230ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:04 AM [express] POST /api/production-orders/preview-quantities 200 in 235ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:04 AM [express] POST /api/production-orders/preview-quantities 200 in 210ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:05 AM [express] POST /api/production-orders/preview-quantities 200 in 167ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:05 AM [express] POST /api/production-orders/preview-quantities 200 in 217ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:06 AM [express] POST /api/production-orders/preview-quantities 200 in 214ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:06 AM [express] POST /api/production-orders/preview-quantities 200 in 202ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:07 AM [express] POST /api/production-orders/preview-quantities 200 in 163ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:07 AM [express] POST /api/production-orders/preview-quantities 200 in 240ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:08 AM [express] POST /api/production-orders/preview-quantities 200 in 219ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:11 AM [express] POST /api/production-orders/preview-quantities 200 in 508ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:11 AM [express] POST /api/production-orders/preview-quantities 200 in 198ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:11 AM [express] POST /api/production-orders/preview-quantities 200 in 176ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:11 AM [express] POST /api/production-orders/preview-quantities 200 in 175ms :: {"success":true,…
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
🔄 Session extended for user 1 on /api/production-orders/preview-quantities
1:18:23 AM [express] POST /api/production-orders/preview-quantities 200 in 671ms :: {"success":true,…
1:18:23 AM [express] POST /api/production-orders/preview-quantities 200 in 714ms :: {"success":true,…
1:18:23 AM [express] POST /api/production-orders/preview-quantities 200 in 693ms :: {"success":true,…
🔄 Session extended for user 1 on /api/orders/next-number
1:18:26 AM [express] GET /api/orders/next-number 200 in 117ms :: {"orderNumber":"ORD002"}
🔄 Session extended for user 1 on /api/orders
🔍 Validating request body: {
  "order_number": "ORD002",
  "customer_id": "CID083",
  "delivery_days": 15,
  "notes": "",
  "created_by": "1"
}
✅ Validation successful
[DataValidator] 🔒 Validating orders entity: {
  tableName: 'orders',
  isUpdate: false,
  dataKeys: [
    'order_number',
    'customer_id',
    'delivery_days',
    'status',
    'notes',
    'created_by',
    'delivery_date'
  ]
}
[DataValidator] ✅ Validation passed for orders
[Storage] ✅ Order validation passed, proceeding with database write
1:18:27 AM [express] POST /api/orders 201 in 148ms :: {"data":"[Object]","message":"تم إنشاء الطلب ب…
🔄 Session extended for user 1 on /api/production-orders
[DataValidator] 🔒 Validating production_orders entity: {
  tableName: 'production_orders',
  isUpdate: false,
  dataKeys: [
    'order_id',
    'customer_product_id',
    'quantity_kg',
    'overrun_percentage',
    'status'
  ]
}
[DataValidator] ✅ Validation passed for production_orders
[Storage] ✅ Production order validation passed, proceeding with database write
Created production order PO002 with intelligent quantities: {
  baseQuantity: 1000,
  punchingType: 'بدون',
  overrunPercentage: 5,
  finalQuantity: 1050,
  reason: 'منتج عادي'
}
1:18:28 AM [express] POST /api/production-orders 201 in 914ms :: {"id":44,"production_order_number":…
🔄 Session extended for user 1 on /api/production-orders
[DataValidator] 🔒 Validating production_orders entity: {
  tableName: 'production_orders',
  isUpdate: false,
  dataKeys: [
    'order_id',
    'customer_product_id',
    'quantity_kg',
    'overrun_percentage',
    'status'
  ]
}
[DataValidator] ✅ Validation passed for production_orders
[Storage] ✅ Production order validation passed, proceeding with database write
Created production order PO003 with intelligent quantities: {
  baseQuantity: 600,
  punchingType: 'بدون',
  overrunPercentage: 5,
  finalQuantity: 630,
  reason: 'منتج عادي'
}
1:18:29 AM [express] POST /api/production-orders 201 in 636ms :: {"id":45,"production_order_number":…
🔄 Session extended for user 1 on /api/orders
🔄 Session extended for user 1 on /api/production-orders
1:18:29 AM [express] GET /api/orders 200 in 119ms :: {"data":"[Array:2]","count":2,"success":true}
1:18:30 AM [express] GET /api/production-orders 200 in 471ms :: {"data":"[Array:3]"}
🔄 Session extended for user 1 on /api/production/hierarchical-orders
🔄 Session extended for user 1 on /api/production/cutting-queue
🔄 Session extended for user 1 on /api/notifications
🔄 Session extended for user 1 on /api/production/grouped-cutting-queue
1:19:50 AM [express] GET /api/notifications 304 in 344ms :: {"data":"[Array:0]"}
1:19:50 AM [express] GET /api/production/cutting-queue 304 in 347ms :: {"data":"[Array:0]"}
1:19:50 AM [express] GET /api/production/grouped-cutting-queue 304 in 120ms :: {"data":"[Array:0]"}
1:19:50 AM [express] GET /api/production/hierarchical-orders 200 in 514ms :: {"data":"[Array:2]"}
🔄 Session extended for user 1 on /api/production/film-queue
🔄 Session extended for user 1 on /api/production/printing-queue
🔄 Session extended for user 1 on /api/machines
🔄 Session extended for user 1 on /api/rolls
1:19:50 AM [express] GET /api/production/printing-queue 304 in 121ms :: {"data":"[Array:0]"}
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713590731_6c1zcnrjt
[SSE] New connection established for user 1, connectionId: 1_1759713590731_6c1zcnrjt
1:19:50 AM [express] GET /api/production/film-queue 304 in 127ms :: {"data":"[Array:1]"}
1:19:50 AM [express] GET /api/machines 304 in 129ms :: {"data":"[Array:25]"}
1:19:50 AM [express] GET /api/rolls 304 in 303ms :: {"data":"[Array:0]"}
🔄 Session extended for user 1 on /api/customer-products
🔄 Session extended for user 1 on /api/users
🔄 Session extended for user 1 on /api/customers
🔄 Session extended for user 1 on /api/items
1:19:57 AM [express] GET /api/users 304 in 120ms :: {"data":"[Array:50]"}
1:19:57 AM [express] GET /api/items 304 in 126ms :: {"data":"[Array:72]"}
1:19:57 AM [express] GET /api/customers 304 in 368ms :: {"data":"[Array:2172]"}
1:19:57 AM [express] GET /api/customer-products 304 in 679ms :: {"data":"[Array:4817]"}
🔄 Session extended for user 1 on /api/orders/74/status
[DataValidator] 🔄 Validating status transition for orders: { entityId: 74, currentStatus: 'waiting', newStatus: 'for_production' }
[DataValidator] ✅ Valid status transition: waiting → for_production
[Storage] ✅ Valid status transition: waiting → for_production
1:20:00 AM [express] PATCH /api/orders/74/status 200 in 617ms :: {"data":"[Object]","message":"تم تغ…
🔄 Session extended for user 1 on /api/orders
🔄 Session extended for user 1 on /api/production-orders
1:20:00 AM [express] GET /api/orders 200 in 119ms :: {"data":"[Array:2]","count":2,"success":true}
1:20:00 AM [express] GET /api/production-orders 200 in 120ms :: {"data":"[Array:3]"}
[NotificationManager] Running memory cleanup...
[NotificationManager] Memory cleanup completed. Active connections: 0, Cleaned invalid: 0
🔄 Session extended for user 1 on /api/notifications/stream
[NotificationManager] Adding SSE connection for user 1, connection: 1_1759713605916_k1nbeyhtg
[SSE] New connection established for user 1, connectionId: 1_1759713605916_k1nbeyhtg
🔄 Session extended for user 1 on /api/production/hierarchical-orders
1:20:06 AM [express] GET /api/production/hierarchical-orders 200 in 240ms :: {"data":"[Array:2]"}
[Cache] Cleaned up 1 stale entries. Active: 1
🔄 Session extended for user 1 on /api/production/hierarchical-orders
1:21:37 AM [express] GET /api/production/hierarchical-orders 304 in 429ms :: {"data":"[Array:2]"}
[Cache] Cleaned up 1 stale entries. Active: 0
🔄 Session extended for user 1 on /api/production/hierarchical-orders
1:23:08 AM [express] GET /api/production/hierarchical-orders 304 in 444ms :: {"data":"[Array:2]"}
[Cache] Cleaned up 1 stale entries. Active: 0
🔄 Session extended for user 1 on /api/production/hierarchical-orders
1:24:44 AM [express] GET /api/production/hierarchical-orders 304 in 2562ms :: {"data":"[Array:2]"}
[SystemHealthMonitor] تم رصد مؤشرات الأداء
[SystemHealthMonitor] فحص الطلبات المتأخرة
[SystemHealthMonitor] فحص حالة المكائن
[SystemHealthMonitor] فحص المواد قليلة المخزون
[SystemHealthMonitor] تم تنظيف البيانات القديمة
[Cache] Cleaned up 1 stale entries. Active: 0
🔄 Session extended for user 1 on /api/notifications
1:26:13 AM [express] GET /api/notifications 304 in 302ms :: {"data":"[Array:0]"}
🔄 Session extended for user 1 on /api/customers
🔄 Session extended for user 1 on /api/items
1:26:14 AM [express] GET /api/items 304 in 311ms :: {"data":"[Array:72]"}
🔄 Session extended for user 1 on /api/sections
🔄 Session extended for user 1 on /api/categories
🔄 Session extended for user 1 on /api/customer-products
1:26:14 AM [express] GET /api/customers 304 in 380ms :: {"data":"[Array:2172]"}
🔄 Session extended for user 1 on /api/machines
1:26:14 AM [express] GET /api/sections 304 in 116ms :: {"data":"[Array:7]"}
1:26:14 AM [express] GET /api/categories 304 in 152ms :: {"data":"[Array:10]"}
1:26:14 AM [express] GET /api/machines 304 in 310ms :: {"data":"[Array:25]"}
🔄 Session extended for user 1 on /api/users
🔄 Session extended for user 1 on /api/locations
🔄 Session extended for user 1 on /api/roles
1:26:15 AM [express] GET /api/customer-products 200 in 840ms :: {"data":"[Array:4817]"}
1:26:15 AM [express] GET /api/users 304 in 118ms :: {"data":"[Array:50]"}
1:26:15 AM [express] GET /api/roles 304 in 118ms :: {"data":"[Array:7]"}
1:26:15 AM [express] GET /api/locations 304 in 120ms :: {"data":"[Array:2]"}
🔄 Session extended for user 1 on /api/customer-products/33
Customer product validation error: [
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'width' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'left_facing' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'right_facing' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'thickness' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'unit_weight_kg' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'package_weight_kg' ],
    message: 'Expected string, received number'
  }
]
🔄 Session extended for user 1 on /api/customer-products/33
Customer product validation error: [
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'width' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'left_facing' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'right_facing' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'thickness' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'unit_weight_kg' ],
    message: 'Expected string, received number'
  },
  {
    code: 'invalid_type',
    expected: 'string',
    received: 'number',
    path: [ 'package_weight_kg' ],
    message: 'Expected string, received number'
  }
]
1:27:42 AM [express] PUT /api/customer-products/33 400 in 2412ms :: {"message":"بيانات غير صحيحة","e…
[NotificationManager] Running memory cleanup...
[NotificationManager] Memory cleanup completed. Active connections: 0, Cleaned invalid: 0
[SystemHealthMonitor] تم تحسن حالة اتصال قاعدة البيانات من healthy إلى warning
[DatabaseStorage] تم تسجيل وقت التحذير في الذاكرة: Database Connection_health_alert في 2025-10-06T01:30:15.135Z
[SystemHealthMonitor] تم تسجيل إرسال التحذير: Database Connection_health_alert في 2025-10-06T01:30:15.135Z
[SystemHealthMonitor] تم إنشاء تحذير النظام: مشكلة في سلامة النظام: اتصال قاعدة البيانات
[SystemHealthMonitor] تم تحسن حالة أداء قاعدة البيانات من healthy إلى warning
[DatabaseStorage] تم تسجيل وقت التحذير في الذاكرة: Database Performance_health_alert في 2025-10-06T01:30:15.435Z
[SystemHealthMonitor] تم تسجيل إرسال التحذير: Database Performance_health_alert في 2025-10-06T01:30:15.435Z
[SystemHealthMonitor] تم إنشاء تحذير النظام: مشكلة في سلامة النظام: أداء قاعدة البيانات